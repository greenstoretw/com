<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綠色商店後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar-item { transition: all 0.2s ease-in-out; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #10B981; color: white; transform: translateX(4px); }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-200">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center text-gray-800">後台管理登入</h2>
                <form id="loginForm">
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">密碼</label>
                        <input type="password" id="password" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500" placeholder="請輸入密碼" required>
                    </div>
                    <button type="submit" id="loginButton" class="w-full px-4 py-2 font-semibold text-white bg-emerald-600 rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2">登入</button>
                </form>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="flex h-screen bg-gray-100">
                <!-- Sidebar -->
                <div class="w-64 bg-gray-800 text-white flex flex-col">
                    <div class="px-8 py-6 text-2xl font-bold">管理系統</div>
                    <nav class="flex-1 px-4 py-4 space-y-2">
                        <a href="#" data-section="mainDashboard" class="sidebar-item active flex items-center px-4 py-2 rounded-md"><i class="fas fa-tachometer-alt w-6"></i>儀表板</a>
                        <a href="#" data-section="subscribers" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-users w-6"></i>訂閱者管理</a>
                        <a href="#" data-section="announcements" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-bullhorn w-6"></i>公告管理</a>
                        <a href="#" data-section="policies" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-file-alt w-6"></i>政策管理</a>
                        <a href="#" data-section="shops" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-store w-6"></i>店家管理</a>
                    </nav>
                    <div class="px-4 py-4"><button id="logoutButton" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"><i class="fas fa-sign-out-alt mr-2"></i>登出</button></div>
                </div>

                <!-- Main Content -->
                <main class="flex-1 p-8 overflow-y-auto" id="mainContent"></main>
            </div>
        </div>
    </div>
    
    <!-- Modals and Indicators -->
    <div id="loadingIndicator" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-25"><div class="spinner h-16 w-16 border-4 border-gray-300 rounded-full"></div></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden"></div>
    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-red-700 text-center mb-4">發生錯誤</h3>
            <div class="bg-red-50 p-4 rounded-md max-h-80 overflow-y-auto"><pre id="errorDetails" class="text-xs text-left text-gray-800 whitespace-pre-wrap break-all"></pre></div>
            <div class="mt-4 text-center"><button id="closeErrorModal" class="px-6 py-2 bg-red-600 text-white text-base font-medium rounded-md">關閉</button></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbyJ76tpxJ2eeRRqcv3qUqx3Z8nWLqrNsAIxgMR5vnkfmJOXulhhu1Av2T9w4AzDLg83gA/exec';

    const ui = {
        loginScreen: document.getElementById('loginScreen'),
        dashboard: document.getElementById('dashboard'),
        loginForm: document.getElementById('loginForm'),
        logoutButton: document.getElementById('logoutButton'),
        sidebarItems: document.querySelectorAll('.sidebar-item'),
        mainContent: document.getElementById('mainContent'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        toast: document.getElementById('toast'),
        errorModal: document.getElementById('errorModal'),
        errorDetails: document.getElementById('errorDetails'),
        closeErrorModal: document.getElementById('closeErrorModal'),
    };

    const showToast = (message) => {
        ui.toast.textContent = message;
        ui.toast.classList.remove('hidden');
        setTimeout(() => ui.toast.classList.add('hidden'), 3000);
    };

    const showErrorModal = (error) => {
        let details = `錯誤訊息: ${error.message}\n\n`;
        if (error.apiMessage) details += `後端訊息: ${error.apiMessage}\n\n`;
        if (error.stack) details += `堆疊追蹤:\n${error.stack}`;
        ui.errorDetails.textContent = details;
        ui.errorModal.classList.remove('hidden');
    };

    async function apiFetch(action, params = {}) {
        ui.loadingIndicator.classList.remove('hidden');
        try {
            const token = localStorage.getItem('authToken');
            if (action !== 'login' && !token) {
                logout(); // If token is missing for an auth'd request, log out.
                throw new Error("Auth token not found. Please log in again.");
            }
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, token, ...params }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();

            if (result.status === 'error') {
                if (result.message.toLowerCase().includes('token')) logout();
                throw new Error(result.message);
            }
            return result.data;
        } catch (error) {
            showErrorModal(error);
            throw error;
        } finally {
            ui.loadingIndicator.classList.add('hidden');
        }
    }

    const login = async (password) => {
        try {
            const data = await apiFetch('login', { payload: { password } }); // Ensure password is in payload object
            if (data && data.token) {
                localStorage.setItem('authToken', data.token);
                // **FIX**: Directly transition UI instead of calling checkLogin() to avoid race condition
                ui.loginScreen.classList.add('hidden');
                ui.dashboard.classList.remove('hidden');
                navigateTo('mainDashboard');
            } else {
                throw new Error('登入失敗，未收到權杖。');
            }
        } catch (error) {
            document.getElementById('password').value = '';
        }
    };

    const logout = () => {
        localStorage.removeItem('authToken');
        ui.dashboard.classList.add('hidden');
        ui.loginScreen.classList.remove('hidden');
        ui.mainContent.innerHTML = ''; // Clear content on logout
    };

    const checkLogin = () => {
        if (localStorage.getItem('authToken')) {
            ui.loginScreen.classList.add('hidden');
            ui.dashboard.classList.remove('hidden');
            navigateTo('mainDashboard');
        } else {
            ui.dashboard.classList.add('hidden');
            ui.loginScreen.classList.remove('hidden');
        }
    };
    
    const pageRenderers = {
        mainDashboard: async () => {
            const data = await apiFetch('getDashboardStats');
            return `<h1 class="text-3xl font-bold mb-6">儀表板</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-white rounded-lg shadow"><h2 class="text-lg font-medium text-gray-600">總訂閱數</h2><p class="text-4xl font-bold text-emerald-600 mt-2">${data.totalSubscribers}</p></div>
                        <div class="p-6 bg-white rounded-lg shadow"><h2 class="text-lg font-medium text-gray-600">總店家數</h2><p class="text-4xl font-bold text-blue-600 mt-2">${data.totalShops}</p></div>
                    </div>`;
        },
        subscribers: async () => {
            const data = await apiFetch('getSubscribers');
            return `<h1 class="text-3xl font-bold mb-6">訂閱者管理</h1>
                    <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full"><thead><tr><th class="py-2 px-4 text-left font-semibold">Email</th><th class="py-2 px-4 text-left font-semibold">訂閱時間</th></tr></thead>
                    <tbody>${data.subscribers.map(s => `<tr><td class="py-2 px-4 border-b">${s.email}</td><td class="py-2 px-4 border-b">${s.timestamp}</td></tr>`).join('')}</tbody>
                    </table></div>`;
        },
        announcements: async () => {
            const data = await apiFetch('getAnnouncements');
            return `<h1 class="text-3xl font-bold mb-6">公告管理</h1>
                    <div class="bg-white p-6 rounded-lg shadow">
                    <label for="announcementsEditor" class="block text-lg font-medium mb-2">公告內容 (支援換行)</label>
                    <textarea id="announcementsEditor" class="w-full h-48 p-3 border rounded focus:ring-emerald-500 focus:border-emerald-500">${data.announcements}</textarea>
                    <button id="saveAnnouncements" class="mt-4 px-4 py-2 text-white bg-emerald-600 rounded hover:bg-emerald-700">儲存公告</button>
                    </div>`;
        },
        policies: async () => {
            const data = await apiFetch('getPolicies');
            return `<h1 class="text-3xl font-bold mb-6">政策管理</h1>
                    <div class="bg-white p-6 rounded-lg shadow space-y-6">
                    <div><label for="privacyPolicy" class="block text-lg font-medium mb-2">隱私權政策</label><textarea id="privacyPolicy" class="w-full h-48 p-3 border rounded focus:ring-emerald-500 focus:border-emerald-500">${data.privacy || ''}</textarea><button data-key="privacy" class="save-policy mt-2 px-4 py-2 text-white bg-emerald-600 rounded hover:bg-emerald-700">儲存</button></div>
                    <div><label for="disclaimer" class="block text-lg font-medium mb-2">免責聲明</label><textarea id="disclaimer" class="w-full h-48 p-3 border rounded focus:ring-emerald-500 focus:border-emerald-500">${data.disclaimer || ''}</textarea><button data-key="disclaimer" class="save-policy mt-2 px-4 py-2 text-white bg-emerald-600 rounded hover:bg-emerald-700">儲存</button></div>
                    </div>`;
        },
        shops: async () => {
            const data = await apiFetch('getShops');
            return `<h1 class="text-3xl font-bold mb-6">店家管理</h1>
                    <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full"><thead><tr><th class="py-2 px-4 text-left font-semibold">店家名稱</th><th class="py-2 px-4 text-left font-semibold">類型</th><th class="py-2 px-4 text-left font-semibold">地址</th></tr></thead>
                    <tbody>${data.shops.map(s => `<tr><td class="py-2 px-4 border-b">${s['name_zh-TW']}</td><td class="py-2 px-4 border-b">${s['type_zh-TW']}</td><td class="py-2 px-4 border-b">${s['address_zh-TW']}</td></tr>`).join('')}</tbody>
                    </table></div>`;
        }
    };

    const navigateTo = async (sectionId) => {
        ui.sidebarItems.forEach(i => i.classList.remove('active'));
        document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
        try {
            ui.mainContent.innerHTML = await pageRenderers[sectionId]();
        } catch(e) {
            // Error is already shown by apiFetch, just prevent content from breaking
            ui.mainContent.innerHTML = `<div class="text-red-500 p-4 bg-red-100 rounded">無法載入此區塊的內容。</div>`;
        }
    };
    
    const setupEventListeners = () => {
        ui.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            login(document.getElementById('password').value);
        });
        ui.logoutButton.addEventListener('click', logout);
        ui.closeErrorModal.addEventListener('click', () => ui.errorModal.classList.add('hidden'));

        ui.sidebarItems.forEach(item => item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(e.currentTarget.dataset.section);
        }));
        
        ui.mainContent.addEventListener('click', async (e) => {
            if (e.target.id === 'saveAnnouncements') {
                const content = document.getElementById('announcementsEditor').value;
                await apiFetch('setAnnouncements', { payload: { content } });
                showToast('公告已儲存');
            }
            if (e.target.classList.contains('save-policy')) {
                const key = e.target.dataset.key;
                const value = document.getElementById(key).value;
                await apiFetch('setPolicy', { payload: { key, value } });
                showToast('政策已儲存');
            }
        });
    };

    setupEventListeners();
    checkLogin();
});
</script>
</body>
</html>

