<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>永續商店後台管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .toast { position: fixed; top: 1rem; right: 1rem; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 50; }
    .toast-success { background: #10B981; color: white; }
    .toast-error { background: #EF4444; color: white; }
  </style>
</head>
<body class="bg-gray-100">

<div class="flex h-screen">
  <!-- 側邊欄 -->
  <aside class="w-64 bg-white shadow flex flex-col">
    <div class="p-6 text-2xl font-bold text-green-600">後台管理</div>
    <nav class="flex-1">
      <button class="w-full text-left px-6 py-3 hover:bg-green-50" data-page="shops">商店管理</button>
      <button class="w-full text-left px-6 py-3 hover:bg-green-50" data-page="subscribers">訂閱者管理</button>
      <button class="w-full text-left px-6 py-3 hover:bg-green-50" data-page="announcements">公告管理</button>
    </nav>
  </aside>

  <!-- 主內容 -->
  <main class="flex-1 p-6 overflow-y-auto">
    <!-- 商店管理 -->
    <section id="page-shops" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">商店列表</h2>
        <button id="add-shop" class="bg-green-600 text-white px-4 py-2 rounded">新增商店</button>
      </div>
      <div id="shops-container" class="bg-white rounded shadow p-4">載入中...</div>
    </section>

    <!-- 訂閱者管理 -->
    <section id="page-subscribers" class="hidden">
      <h2 class="text-2xl font-bold mb-4">訂閱者列表</h2>
      <div id="subs-container" class="bg-white rounded shadow p-4">載入中...</div>
    </section>

    <!-- 公告管理 -->
    <section id="page-announcements" class="hidden">
      <h2 class="text-2xl font-bold mb-4">公告管理</h2>
      <textarea id="announcement-text" class="w-full border rounded p-2 mb-2"></textarea>
      <button id="save-announcement" class="bg-blue-600 text-white px-4 py-2 rounded">發布公告</button>
    </section>
  </main>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwREhwZHhBDzHj5KWMlayvzmQ4jGNIbW74CYCqQYIuDdEMqgp5pNnbneoVhk4esFjx7fQ/exec";

function showToast(msg, type="success"){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className = 'toast ' + (type==='success'?'toast-success':'toast-error');
  t.classList.remove('hidden');
  setTimeout(()=>t.classList.add('hidden'),3000);
}

// 導航
document.querySelectorAll("aside button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
    document.getElementById("page-"+btn.dataset.page).classList.remove("hidden");
    if(btn.dataset.page==="shops") loadShops();
    if(btn.dataset.page==="subscribers") loadSubscribers();
    if(btn.dataset.page==="announcements") loadAnnouncement();
  });
});

// 載入商店
async function loadShops(){
  try{
    const r=await fetch(API+"?action=getShops");
    const j=await r.json();
    if(!j.success) throw new Error(j.error);
    const container=document.getElementById("shops-container");
    container.innerHTML="";
    Object.values(j.shops).forEach(s=>{
      const card=document.createElement("div");
      card.className="p-4 mb-3 border rounded shadow-sm hover:shadow";
      card.innerHTML=`<div class="font-bold">${s["name_zh-TW"]||s["name_en"]}</div>
      <div class="text-sm text-gray-600">${s.type_zh-TW||s.type_en}</div>
      <div class="text-sm text-gray-600">${s.address_zh-TW||s.address_en}</div>`;
      container.appendChild(card);
    });
  }catch(e){showToast("讀取商店失敗","error");}
}

// 載入訂閱者
async function loadSubscribers(){
  try{
    const r=await fetch(API+"?action=getEmails");
    const j=await r.json();
    if(!j.success) throw new Error(j.error);
    const c=document.getElementById("subs-container");
    c.innerHTML="";
    j.emails.forEach(em=>{
      const li=document.createElement("div");
      li.className="p-2 border-b";
      li.textContent=em;
      c.appendChild(li);
    });
  }catch(e){showToast("讀取訂閱者失敗","error");}
}

// 載入公告
async function loadAnnouncement(){
  try{
    const r=await fetch(API+"?action=getAnnouncement");
    const j=await r.json();
    if(!j.success) throw new Error(j.error);
    document.getElementById("announcement-text").value=j.announcement||"";
  }catch(e){showToast("讀取公告失敗","error");}
}

// 儲存公告
document.getElementById("save-announcement").addEventListener("click",async()=>{
  const content=document.getElementById("announcement-text").value;
  try{
    await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"setAnnouncement",content})});
    showToast("公告已更新","success");
  }catch(e){showToast("公告更新失敗","error");}
});
</script>
</body>
</html>
