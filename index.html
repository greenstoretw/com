<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綠色商店後台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sidebar-item { transition: all 0.2s ease-in-out; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #10B981; color: white; transform: translateX(4px); }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-content { max-height: 85vh; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center text-gray-800">後台管理登入</h2>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                        <input type="password" id="password" name="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-emerald-600 rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">登入</button>
                    </div>
                    <p id="loginError" class="text-sm text-center text-red-600"></p>
                </form>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="mainDashboard" class="hidden">
            <div class="flex h-screen bg-gray-100">
                <!-- Sidebar -->
                <aside class="w-64 bg-gray-800 text-gray-200 flex flex-col">
                    <div class="px-6 py-4 text-2xl font-bold text-white">管理系統</div>
                    <nav id="sidebar-nav" class="flex-1 px-4 py-4 space-y-2">
                        <a href="#dashboard" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-tachometer-alt w-6"></i> 總覽</a>
                        <a href="#shops" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-store w-6"></i> 店家管理</a>
                        <a href="#tags" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-tags w-6"></i> 標籤管理</a>
                        <a href="#subscribers" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-users w-6"></i> 訂閱者</a>
                        <a href="#feedback" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-comment-dots w-6"></i> 意見回饋</a>
                        <a href="#announcements" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-bullhorn w-6"></i> 公告設定</a>
                        <a href="#policies" class="sidebar-item flex items-center px-4 py-2 rounded-md"><i class="fas fa-file-contract w-6"></i> 政策設定</a>
                    </nav>
                </aside>
                
                <!-- Main Content -->
                <main id="main-content" class="flex-1 p-6 overflow-y-auto"></main>
            </div>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl">
            <div class="p-6 border-b">
                <h3 id="modal-title" class="text-xl font-semibold">Modal Title</h3>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto modal-content"></div>
            <div class="px-6 py-4 bg-gray-100 border-t flex justify-end">
                <button id="modal-close" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 px-6 py-3 text-white bg-emerald-500 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        <span id="toast-message"></span>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbzqOIV2SfC_pTQ_8LVoXEib5g4qSUGwC-YtzrVUTMlvrdtMg8SXhEV3wsSS92q3KFSbww/exec';
    let adminData = {};
    const LANGUAGES = ['zh-TW', 'en', 'fr', 'de', 'es', 'ja', 'la'];

    const apiFetch = async (action, payload = {}) => {
        const password = sessionStorage.getItem('adminPassword');
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, password, payload })
            });
            const result = await response.json();
            if (!result.success) {
                showToast(`錯誤: ${result.message}`, 'error');
                throw new Error(result.message);
            }
            return result.data;
        } catch (error) {
            showToast(`請求失敗: ${error.message}`, 'error');
            throw error;
        }
    };

    const checkLogin = () => {
        if (sessionStorage.getItem('adminPassword')) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            navigateTo(window.location.hash || '#dashboard');
        }
    };

    const login = async (password) => {
        try {
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'login', payload: { password } })
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    sessionStorage.setItem('adminPassword', password);
                    checkLogin();
                } else {
                    document.getElementById('loginError').textContent = result.message || '登入失敗';
                }
            });
        } catch (error) {
            document.getElementById('loginError').textContent = '網路請求錯誤';
        }
    };

    const showToast = (message, type = 'success') => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed top-5 right-5 px-6 py-3 text-white rounded-lg shadow-lg transition-opacity duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-emerald-500'}`;
        toast.style.opacity = 1;
        setTimeout(() => { toast.style.opacity = 0; }, 3000);
    };

    // --- RENDER FUNCTIONS ---
    const renderDashboard = (data) => {
        return `
            <h1 class="text-3xl font-bold mb-6">總覽</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="p-6 bg-white rounded-lg shadow-md"><div class="text-3xl font-bold text-emerald-600">${data.shops.length}</div><div class="text-gray-500">店家總數</div></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><div class="text-3xl font-bold text-emerald-600">${data.tags.length}</div><div class="text-gray-500">標籤總數</div></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><div class="text-3xl font-bold text-emerald-600">${data.subscribers.length}</div><div class="text-gray-500">訂閱者</div></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><div class="text-3xl font-bold text-emerald-600">${data.feedback.length}</div><div class="text-gray-500">意見回饋</div></div>
            </div>`;
    };
    
    const renderTable = (title, headers, rows, addBtnText) => {
        return `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">${title}</h1>
                ${addBtnText ? `<button class="px-4 py-2 text-white bg-emerald-600 rounded-md hover:bg-emerald-700" data-action="add">${addBtnText}</button>` : ''}
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50"><tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${rows.map(row => `<tr>${row.map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
                </table>
            </div>`;
    };

    const renderShops = (data) => renderTable('店家管理', ['ID', '名稱 (中)', '名稱 (英)', '類型', '操作'], 
        data.map(s => [s.id, s['name_zh-TW'], s.name_en, s['type_zh-TW'], `<button class="text-blue-500 hover:underline mr-2" data-action="edit-shop" data-id="${s.id}">編輯</button><button class="text-red-500 hover:underline" data-action="delete-shop" data-id="${s.id}">刪除</button><button class="text-green-500 hover:underline ml-2" data-action="recommend-shop" data-id="${s.id}">推薦</button>`]),
        '新增店家');

    const renderTags = (data) => renderTable('標籤管理', ['ID', '名稱 (中)', '名稱 (英)', '操作'],
        data.map(t => [t.id, t['name_zh-TW'], t.name_en, `<button class="text-blue-500 hover:underline mr-2" data-action="edit-tag" data-id="${t.id}">編輯</button><button class="text-red-500 hover:underline" data-action="delete-tag" data-id="${t.id}">刪除</button>`]),
        '新增標籤');

    const renderSubscribers = (data) => renderTable('訂閱者', ['Email', '訂閱時間', '操作'],
        data.map(s => [s.Email, s.Timestamp, `<button class="text-red-500 hover:underline" data-action="delete-subscriber" data-email="${s.Email}">刪除</button>`]));

    const renderFeedback = (data) => renderTable('意見回饋', ['Email', '類型', '訊息', '時間'],
        data.map(f => [f.Email, f.Type, `<div class="w-64 truncate">${f.Message}</div>`, f.Timestamp]));

    const renderAnnouncements = (data) => {
        // --- 【修正】更新公告編輯器的取值方式 ---
        const content = data['content_zh-TW'] || '';
        return `
            <h1 class="text-3xl font-bold mb-6">公告設定</h1>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <label for="announcementsEditor" class="block text-sm font-medium text-gray-700 mb-2">公告內容 (僅限繁體中文)</label>
                <textarea id="announcementsEditor" rows="4" class="w-full p-2 border border-gray-300 rounded-md">${content}</textarea>
                <button id="saveAnnouncements" class="mt-4 px-4 py-2 text-white bg-emerald-600 rounded-md hover:bg-emerald-700">儲存公告</button>
            </div>`;
    };
    
    const renderPolicies = (data) => {
        // --- 【修正】更新政策編輯器的取值方式 ---
        const privacy = data.find(p => p.key === 'privacy')?.['value_zh-TW'] || '';
        const disclaimer = data.find(p => p.key === 'disclaimer')?.['value_zh-TW'] || '';
        return `
            <h1 class="text-3xl font-bold mb-6">政策設定</h1>
            <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
                <div>
                    <label for="privacy" class="block text-sm font-medium text-gray-700 mb-2">隱私權政策 (僅限繁體中文)</label>
                    <textarea id="privacy" rows="8" class="w-full p-2 border border-gray-300 rounded-md">${privacy}</textarea>
                    <button class="save-policy mt-2 px-4 py-2 text-white bg-emerald-600 rounded-md hover:bg-emerald-700" data-key="privacy">儲存隱私權政策</button>
                </div>
                <div>
                    <label for="disclaimer" class="block text-sm font-medium text-gray-700 mb-2">免責聲明 (僅限繁體中文)</label>
                    <textarea id="disclaimer" rows="8" class="w-full p-2 border border-gray-300 rounded-md">${disclaimer}</textarea>
                    <button class="save-policy mt-2 px-4 py-2 text-white bg-emerald-600 rounded-md hover:bg-emerald-700" data-key="disclaimer">儲存免責聲明</button>
                </div>
            </div>`;
    };
    
    // --- NAVIGATION ---
    const navigateTo = async (hash) => {
        const page = hash.substring(1) || 'dashboard';
        const mainContent = document.getElementById('main-content');
        
        document.querySelectorAll('#sidebar-nav a').forEach(a => a.classList.remove('active'));
        document.querySelector(`#sidebar-nav a[href="#${page}"]`).classList.add('active');

        mainContent.innerHTML = '<div class="w-16 h-16 border-4 border-gray-300 rounded-full spinner mx-auto mt-20"></div>';
        
        try {
            if (Object.keys(adminData).length === 0) {
                 adminData = await apiFetch('getAdminData');
            }
            let content = '';
            switch (page) {
                case 'dashboard': content = renderDashboard(adminData); break;
                case 'shops': content = renderShops(adminData.shops); break;
                case 'tags': content = renderTags(adminData.tags); break;
                case 'subscribers': content = renderSubscribers(adminData.subscribers); break;
                case 'feedback': content = renderFeedback(adminData.feedback); break;
                case 'announcements': content = renderAnnouncements(adminData.announcements); break;
                case 'policies': content = renderPolicies(adminData.policies); break;
                default: content = '<h2>頁面不存在</h2>';
            }
            mainContent.innerHTML = content;
        } catch (error) {
            mainContent.innerHTML = `<div class="text-red-500">無法載入資料: ${error.message}</div>`;
        }
    };
    
    // --- EVENT LISTENERS ---
    const setupEventListeners = () => {
        document.getElementById('loginForm').addEventListener('submit', e => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            login(password);
        });

        window.addEventListener('hashchange', () => navigateTo(window.location.hash));
        
        document.getElementById('main-content').addEventListener('click', async (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const id = target.dataset.id;
            const email = target.dataset.email;
            
            try {
                if (action === 'add' || action === 'edit-shop') { openShopForm(id); }
                if (action === 'delete-shop' && confirm(`確定要刪除此店家嗎？`)) {
                    await apiFetch('deleteShop', { id });
                    showToast('店家已刪除');
                    adminData = {}; navigateTo('#shops');
                }
                if (action === 'add' || action === 'edit-tag') { openTagForm(id); }
                if (action === 'delete-tag' && confirm(`確定要刪除此標籤嗎？`)) {
                    await apiFetch('deleteTag', { id });
                    showToast('標籤已刪除');
                    adminData = {}; navigateTo('#tags');
                }
                if (action === 'delete-subscriber' && confirm(`確定要刪除此訂閱者嗎？`)) {
                    await apiFetch('deleteSubscriber', { email });
                    showToast('訂閱者已刪除');
                    adminData = {}; navigateTo('#subscribers');
                }
                if (action === 'recommend-shop' && confirm(`確定要向所有訂閱者推薦此店家嗎？`)) {
                    await apiFetch('sendRecommendation', { shopId: id });
                    showToast('推薦信已開始發送');
                }
                if (target.id === 'saveAnnouncements') {
                    const content = document.getElementById('announcementsEditor').value;
                    await apiFetch('setAnnouncements', { content });
                    showToast('公告已儲存');
                    adminData.announcements['content_zh-TW'] = content;
                }
                if (target.classList.contains('save-policy')) {
                    const key = target.dataset.key;
                    const value = document.getElementById(key).value;
                    await apiFetch('setPolicy', { key, value });
                    showToast('政策已儲存');
                    const policy = adminData.policies.find(p => p.key === key);
                    if (policy) policy['value_zh-TW'] = value;
                }
            } catch(error) { /* Handled by apiFetch */ }
        });
    };

    const openModal = (title, content) => {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = content;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal').classList.add('flex');
    };

    const closeModal = () => {
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('modal').classList.remove('flex');
    };
    
    document.getElementById('modal-close').addEventListener('click', closeModal);
    
    // --- FORM HANDLERS ---
    const createFormInput = (id, label, value = '', type = 'text') => {
        if (type === 'textarea') {
            return `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label><textarea id="${id}" name="${id}" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">${value}</textarea></div>`;
        }
        return `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label><input type="${type}" id="${id}" name="${id}" value="${value}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"></div>`;
    };
    
    const openShopForm = (id) => {
        const shop = id ? adminData.shops.find(s => s.id === id) : null;
        let formContent = `<form id="shop-form" class="space-y-4">
            <input type="hidden" name="id" value="${id || ''}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${createFormInput('tags', '標籤 (以逗號分隔)', shop?.tags || '')}
                ${createFormInput('phone', '電話', shop?.phone || '')}
                ${createFormInput('website', '網站', shop?.website || '')}
                ${createFormInput('lat', '緯度', shop?.lat || '')}
                ${createFormInput('lng', '經度', shop?.lng || '')}
            </div>
            <hr class="my-4">`;
            
        LANGUAGES.forEach(lang => {
            formContent += `<div class="p-4 border rounded-md bg-gray-50">
                <h4 class="font-semibold text-lg mb-2">語言: ${lang.toUpperCase()}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${createFormInput(`name_${lang}`, '名稱', shop?.[`name_${lang}`] || '')}
                    ${createFormInput(`type_${lang}`, '類型', shop?.[`type_${lang}`] || '')}
                    ${createFormInput(`address_${lang}`, '地址', shop?.[`address_${lang}`] || '', 'textarea')}
                    ${createFormInput(`description_${lang}`, '簡短描述', shop?.[`description_${lang}`] || '', 'textarea')}
                    ${createFormInput(`longDescription_${lang}`, '詳細描述', shop?.[`longDescription_${lang}`] || '', 'textarea')}
                </div>
            </div>`;
        });
        
        formContent += `<button type="submit" class="mt-4 px-4 py-2 text-white bg-emerald-600 rounded-md hover:bg-emerald-700">儲存店家</button></form>`;
        openModal(id ? '編輯店家' : '新增店家', formContent);
        
        document.getElementById('shop-form').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            await apiFetch('saveShop', payload);
            showToast('店家已儲存');
            closeModal();
            adminData = {}; navigateTo('#shops');
        });
    };

    const openTagForm = (id) => {
        const tag = id ? adminData.tags.find(t => t.id === id) : null;
        let formContent = `<form id="tag-form" class="space-y-4">
            <input type="hidden" name="id" value="${id || ''}">`;
        
        LANGUAGES.forEach(lang => {
            formContent += createFormInput(`name_${lang}`, `名稱 (${lang.toUpperCase()})`, tag?.[`name_${lang}`] || '');
        });
            
        formContent += `<button type="submit" class="mt-4 px-4 py-2 text-white bg-emerald-600 rounded-md hover:bg-emerald-700">儲存標籤</button></form>`;
        openModal(id ? '編輯標籤' : '新增標籤', formContent);
        
        document.getElementById('tag-form').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            await apiFetch('saveTag', payload);
            showToast('標籤已儲存');
            closeModal();
            adminData = {}; navigateTo('#tags');
        });
    };

    setupEventListeners();
    checkLogin();
});
</script>
</body>
</html>
