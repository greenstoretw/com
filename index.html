<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸çºŒå•†åº—åœ°åœ– - ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .tab-active {
            border-bottom: 2px solid #4ade80; /* green-400 */
            color: #4ade80;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-sans">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center text-green-400 mb-6">ç®¡ç†å¾Œå°ç™»å…¥</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="block text-gray-400 mb-2">å¯†ç¢¼</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300">ç™»å…¥</button>
            </form>
            <p id="login-error" class="text-red-400 text-center mt-4"></p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-screen" class="hidden">
        <div class="flex h-screen bg-gray-900">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-gray-300 flex flex-col">
                <div class="p-4 text-2xl font-bold text-white border-b border-gray-700">
                    <i class="fas fa-leaf text-green-400"></i> ç®¡ç†é¸å–®
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" data-tab="dashboard" class="tab-link tab-active flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-tachometer-alt fa-fw mr-3"></i> å„€è¡¨æ¿
                    </a>
                    <a href="#" data-tab="subscribers" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-users fa-fw mr-3"></i> è¨‚é–±è€…ç®¡ç†
                    </a>
                    <a href="#" data-tab="shops" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-store fa-fw mr-3"></i> åº—å®¶ç®¡ç†
                    </a>
                    <a href="#" data-tab="content" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-file-alt fa-fw mr-3"></i> å…¬å‘Šèˆ‡æ”¿ç­–
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-button" class="w-full flex items-center justify-center p-3 bg-red-600 hover:bg-red-700 rounded-lg transition">
                        <i class="fas fa-sign-out-alt fa-fw mr-2"></i> ç™»å‡º
                    </button>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
                <div id="tab-content">
                    <!-- Dashboard Content -->
                    <div id="dashboard-content" class="tab-pane">
                        <h1 class="text-3xl font-bold mb-6 text-white">å„€è¡¨æ¿</h1>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold text-gray-400">ç¸½è¨‚é–±æ•¸</h2>
                                <p id="subscriber-count" class="text-4xl font-bold text-green-400">0</p>
                            </div>
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold text-gray-400">ç¸½åº—å®¶æ•¸</h2>
                                <p id="shop-count" class="text-4xl font-bold text-green-400">0</p>
                            </div>
                             <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold text-gray-400">ç¸½å›å ±æ•¸</h2>
                                <p id="feedback-count" class="text-4xl font-bold text-green-400">0</p>
                            </div>
                        </div>
                    </div>
                    <!-- Subscribers Content -->
                    <div id="subscribers-content" class="tab-pane hidden">
                        <h1 class="text-3xl font-bold mb-6 text-white">è¨‚é–±è€…ç®¡ç†</h1>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3">é›»å­éƒµä»¶</th>
                                        <th class="p-3">è¨‚é–±æ™‚é–“</th>
                                        <th class="p-3">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="subscribers-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Shops Content -->
                    <div id="shops-content" class="tab-pane hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-white">åº—å®¶ç®¡ç†</h1>
                            <button id="add-shop-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-plus mr-2"></i> æ–°å¢åº—å®¶
                            </button>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3">ID</th>
                                        <th class="p-3">ä¸­æ–‡åç¨±</th>
                                        <th class="p-3">é¡å‹</th>
                                        <th class="p-3">åœ°å€</th>
                                        <th class="p-3">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="shops-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Content (Announcements/Policies) Content -->
                    <div id="content-content" class="tab-pane hidden">
                        <h1 class="text-3xl font-bold mb-6 text-white">å…¬å‘Šèˆ‡æ”¿ç­–ç®¡ç†</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Announcements -->
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-xl font-bold mb-4">ç¶²ç«™å…¬å‘Š</h2>
                                <textarea id="announcements-text" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                <button id="save-announcements-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜å…¬å‘Š</button>
                            </div>
                            <!-- Policies -->
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-xl font-bold mb-4">æ”¿ç­–å…§å®¹</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="font-bold">éš±ç§æ¬Šæ”¿ç­–</label>
                                        <textarea id="policy-privacy" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                        <button onclick="savePolicy('privacy')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜éš±ç§æ¬Šæ”¿ç­–</button>
                                    </div>
                                    <div>
                                        <label class="font-bold">å…è²¬è²æ˜</label>
                                        <textarea id="policy-disclaimer" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                        <button onclick="savePolicy('disclaimer')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜å…è²¬è²æ˜</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Shop Edit Modal -->
    <div id="shop-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 id="shop-modal-title" class="text-2xl font-bold mb-6 text-green-400">ç·¨è¼¯åº—å®¶</h2>
            <form id="shop-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <input type="hidden" id="shop-id">
                <!-- Dynamically generated fields will be injected here -->
            </form>
            <div id="shop-form-fields" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"></div>
             <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-shop-edit" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">å–æ¶ˆ</button>
                <button type="button" id="save-shop-btn" class="px-6 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        // =================================================================
        // CONFIGURATION
        // =================================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyQz6D5P90b4d45p6QN_J5iUaIpjU0Xz6P5eF8B8D7k9R6J3s9S9a7Z8c7K6v5B4N3d/exec';
        
        // =================================================================
        // DOM ELEMENTS
        // =================================================================
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // =================================================================
        // API CALLER
        // =================================================================
        const apiCall = async (action, payload = {}) => {
            const token = localStorage.getItem('jwtToken');
            if (!token && action !== 'login') {
                showLoginScreen();
                throw new Error('No token found');
            }

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    // [ğŸ”§ FIXED] Added redirect and headers for better compatibility
                    redirect: "follow",
                    body: JSON.stringify({ action, token, ...payload }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });

                const result = await response.json();
                
                if (result.status === 'error') {
                    if (result.message.includes('token')) {
                        showLoginScreen();
                    }
                    throw new Error(result.message);
                }
                return result.data;

            } catch (error) {
                console.error(`API call failed for action "${action}":`, error);
                alert(`æ“ä½œå¤±æ•—: ${error.message}`);
                throw error;
            }
        };
        
        // =================================================================
        // AUTHENTICATION
        // =================================================================
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            
            try {
                const data = await apiCall('login', { password });
                localStorage.setItem('jwtToken', data.token);
                showDashboardScreen();
            } catch (error) {
                loginError.textContent = `ç™»å…¥å¤±æ•—ï¼š${error.message}`;
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('jwtToken');
            showLoginScreen();
        });

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            dashboardScreen.classList.add('hidden');
        }

        function showDashboardScreen() {
            loginScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            loadDashboardStats();
            switchTab('dashboard'); // Default to dashboard tab
        }
        
        // Check for token on page load
        if (localStorage.getItem('jwtToken')) {
            showDashboardScreen();
        }

        // =================================================================
        // TAB NAVIGATION
        // =================================================================

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = link.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            tabLinks.forEach(link => {
                link.classList.toggle('tab-active', link.dataset.tab === tabName);
            });
            tabPanes.forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== `${tabName}-content`);
            });

            // Load content for the selected tab
            switch (tabName) {
                case 'dashboard':
                    loadDashboardStats();
                    break;
                case 'subscribers':
                    loadSubscribers();
                    break;
                case 'shops':
                    loadShops();
                    break;
                case 'content':
                    loadContent();
                    break;
            }
        }
        
        // =================================================================
        // DATA LOADING & RENDERING
        // =================================================================

        async function loadDashboardStats() {
            try {
                const stats = await apiCall('getDashboardStats');
                document.getElementById('subscriber-count').textContent = stats.subscriberCount;
                document.getElementById('shop-count').textContent = stats.shopCount;
                document.getElementById('feedback-count').textContent = stats.feedbackCount;
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function loadSubscribers() {
            const tableBody = document.getElementById('subscribers-table');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center">è¼‰å…¥ä¸­...</td></tr>';
            try {
                const subscribers = await apiCall('getSubscribers');
                tableBody.innerHTML = subscribers.map(sub => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="p-3">${sub.email}</td>
                        <td class="p-3">${new Date(sub.timestamp).toLocaleString()}</td>
                        <td class="p-3">
                            <button onclick="deleteSubscriber('${sub.email}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-red-400">ç„¡æ³•è¼‰å…¥è¨‚é–±è€…è³‡æ–™</td></tr>';
            }
        }

        async function deleteSubscriber(email) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤è¨‚é–±è€… ${email} å—ï¼Ÿ`)) {
                try {
                    await apiCall('deleteSubscriber', { email });
                    alert('åˆªé™¤æˆåŠŸ');
                    loadSubscribers();
                } catch (error) {
                    // Error handled by apiCall
                }
            }
        }
        
        async function loadShops() {
             const tableBody = document.getElementById('shops-table');
             tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center">è¼‰å…¥ä¸­...</td></tr>';
             try {
                const shops = await apiCall('getShops');
                tableBody.innerHTML = shops.map(shop => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="p-3 font-mono text-sm">${shop.id}</td>
                        <td class="p-3 font-bold">${shop.name_zh_TW}</td>
                        <td class="p-3">${shop.type_zh_TW}</td>
                        <td class="p-3">${shop.address_zh_TW}</td>
                        <td class="p-3 space-x-2">
                            <button onclick="editShop('${shop.id}')" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteShop('${shop.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-400">ç„¡æ³•è¼‰å…¥åº—å®¶è³‡æ–™</td></tr>';
            }
        }

        async function deleteShop(id) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤åº—å®¶ ID: ${id} å—ï¼Ÿ`)) {
                try {
                    await apiCall('deleteShop', { id });
                    alert('åˆªé™¤æˆåŠŸ');
                    loadShops();
                } catch(error) { /* Handled by apiCall */ }
            }
        }
        
        async function loadContent() {
            try {
                const [announcements, policies] = await Promise.all([
                    apiCall('getAnnouncements'),
                    apiCall('getPolicies')
                ]);
                document.getElementById('announcements-text').value = announcements;
                
                policies.forEach(policy => {
                   const key = policy.key.trim();
                   if (document.getElementById(`policy-${key}`)){
                       document.getElementById(`policy-${key}`).value = policy.value;
                   }
                });
            } catch (error) {
                // Error handled
            }
        }

        document.getElementById('save-announcements-btn').addEventListener('click', async () => {
            const announcements = document.getElementById('announcements-text').value;
            try {
                await apiCall('setAnnouncements', { announcements });
                alert('å…¬å‘Šå„²å­˜æˆåŠŸ');
            } catch (error) { /* Handled */ }
        });

        async function savePolicy(policyKey) {
            const content = document.getElementById(`policy-${policyKey}`).value;
            try {
                await apiCall('setPolicy', { key: policyKey, value: content });
                alert(`${policyKey === 'privacy' ? 'éš±ç§æ¬Šæ”¿ç­–' : 'å…è²¬è²æ˜'} å„²å­˜æˆåŠŸ`);
            } catch (error) { /* Handled */ }
        }

        // =================================================================
        // SHOP MODAL LOGIC
        // =================================================================
        const shopModal = document.getElementById('shop-modal');
        const shopFormFields = document.getElementById('shop-form-fields');
        const shopModalTitle = document.getElementById('shop-modal-title');
        const shopIdField = document.getElementById('shop-id');

        const shopFieldDefinitions = [
            { key: 'name_zh-TW', label: 'ä¸­æ–‡åç¨±', type: 'text', required: true },
            { key: 'name_en', label: 'è‹±æ–‡åç¨±', type: 'text', required: true },
            { key: 'type_zh-TW', label: 'ä¸­æ–‡é¡å‹', type: 'text' },
            { key: 'type_en', label: 'è‹±æ–‡é¡å‹', type: 'text' },
            { key: 'address_zh-TW', label: 'ä¸­æ–‡åœ°å€', type: 'text' },
            { key: 'address_en', label: 'è‹±æ–‡åœ°å€', type: 'text' },
            { key: 'hours_zh-TW', label: 'ä¸­æ–‡ç‡Ÿæ¥­æ™‚é–“', type: 'text' },
            { key: 'hours_en', label: 'è‹±æ–‡ç‡Ÿæ¥­æ™‚é–“', type: 'text' },
            { key: 'phone', label: 'é›»è©±', type: 'text' },
            { key: 'email', label: 'é›»å­éƒµä»¶', type: 'email' },
            { key: 'website', label: 'ç¶²ç«™', type: 'text' },
            { key: 'lat', label: 'ç·¯åº¦', type: 'number' },
            { key: 'lng', label: 'ç¶“åº¦', type: 'number' },
            { key: 'description_zh-TW', label: 'ä¸­æ–‡ç°¡çŸ­æè¿°', type: 'textarea' },
            { key: 'description_en', label: 'è‹±æ–‡ç°¡çŸ­æè¿°', type: 'textarea' },
            { key: 'longDescription_zh-TW', label: 'ä¸­æ–‡è©³ç´°æè¿°', type: 'textarea' },
            { key: 'longDescription_en', label: 'è‹±æ–‡è©³ç´°æè¿°', type: 'textarea' },
            { key: 'sustainability_zh-TW', label: 'ä¸­æ–‡æ°¸çºŒç‰¹è‰²', type: 'textarea' },
            { key: 'sustainability_en', label: 'è‹±æ–‡æ°¸çºŒç‰¹è‰²', type: 'textarea' },
            { key: 'tags_zh-TW', label: 'ä¸­æ–‡æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)', type: 'text' },
            { key: 'tags_en', label: 'è‹±æ–‡æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)', type: 'text' },
        ];
        
        // Build the form fields once
        shopFormFields.innerHTML = shopFieldDefinitions.map(field => {
            const inputHtml = field.type === 'textarea'
                ? `<textarea id="shop-${field.key}" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>`
                : `<input type="${field.type}" step="any" id="shop-${field.key}" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" ${field.required ? 'required' : ''}>`;
            
            return `
                <div class="${field.type === 'textarea' ? 'md:col-span-2' : ''}">
                    <label for="shop-${field.key}" class="block text-gray-400 mb-2">${field.label}${field.required ? ' *' : ''}</label>
                    ${inputHtml}
                </div>
            `;
        }).join('');

        document.getElementById('add-shop-btn').addEventListener('click', () => {
            shopModalTitle.textContent = 'æ–°å¢åº—å®¶';
            shopIdField.value = '';
            shopFieldDefinitions.forEach(field => {
                document.getElementById(`shop-${field.key}`).value = '';
            });
            shopModal.classList.remove('hidden');
        });

        async function editShop(id) {
            shopModalTitle.textContent = 'ç·¨è¼¯åº—å®¶';
            shopIdField.value = id;
            try {
                const shop = await apiCall('getShopById', { id });
                shopFieldDefinitions.forEach(field => {
                    document.getElementById(`shop-${field.key}`).value = shop[field.key] || '';
                });
                shopModal.classList.remove('hidden');
            } catch(error) { /* Handled */ }
        }

        document.getElementById('cancel-shop-edit').addEventListener('click', () => {
            shopModal.classList.add('hidden');
        });

        document.getElementById('save-shop-btn').addEventListener('click', async () => {
            const shopData = { id: shopIdField.value };
            let isValid = true;
            shopFieldDefinitions.forEach(field => {
                const input = document.getElementById(`shop-${field.key}`);
                if (field.required && !input.value) {
                    isValid = false;
                }
                shopData[field.key] = input.value;
            });
            
            if(!isValid) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ (*)');
                return;
            }
            
            try {
                await apiCall('saveShop', { shop: shopData });
                alert('åº—å®¶è³‡æ–™å„²å­˜æˆåŠŸ');
                shopModal.classList.add('hidden');
                loadShops();
            } catch(error) { /* Handled */ }
        });
    </script>
</body>
</html>
