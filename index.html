<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永續商店地圖 - 管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .tab-active {
            border-bottom: 2px solid #4ade80; /* green-400 */
            color: #4ade80;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        .status-new { background-color: #3b82f6; color: white; }
        .status-read { background-color: #f59e0b; color: white; }
        .status-resolved { background-color: #10b981; color: white; }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-sans">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center text-green-400 mb-6">管理後台登入</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="block text-gray-400 mb-2">密碼</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300">登入</button>
            </form>
            <p id="login-error" class="text-red-400 text-center mt-4"></p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-screen" class="hidden">
        <div class="relative min-h-screen lg:flex">
            <!-- Mobile Header -->
            <header class="lg:hidden bg-gray-800 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-40">
                <span class="text-xl font-bold"><i class="fas fa-leaf text-green-400"></i> 管理後台</span>
                <button id="mobile-menu-button" class="p-2 focus:outline-none">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
            </header>

            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-gray-800 text-gray-300 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out z-50">
                <div class="p-4 text-2xl font-bold text-white border-b border-gray-700 flex items-center justify-between">
                    <span><i class="fas fa-leaf text-green-400"></i> 管理選單</span>
                    <button id="close-sidebar-button" class="lg:hidden p-2 focus:outline-none">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" data-tab="dashboard" class="tab-link tab-active flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-tachometer-alt fa-fw mr-3"></i> 儀表板
                    </a>
                    <a href="#" data-tab="subscribers" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-users fa-fw mr-3"></i> 訂閱者管理
                    </a>
                    <a href="#" data-tab="shops" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-store fa-fw mr-3"></i> 店家管理
                    </a>
                    <a href="#" data-tab="feedback" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-flag fa-fw mr-3"></i> 回報管理
                    </a>
                    <a href="#" data-tab="content" class="tab-link flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-file-alt fa-fw mr-3"></i> 公告與政策
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <button id="logout-button" class="w-full flex items-center justify-center p-3 bg-red-600 hover:bg-red-700 rounded-lg transition">
                        <i class="fas fa-sign-out-alt fa-fw mr-2"></i> 登出
                    </button>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-6 lg:p-8 overflow-y-auto bg-gray-900">
                <div id="tab-content">
                    <!-- Dashboard Content -->
                    <div id="dashboard-content" class="tab-pane">
                        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-white">儀表板</h1>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold text-gray-400">總訂閱數</h2>
                                <p id="subscriber-count" class="text-4xl font-bold text-green-400">0</p>
                            </div>
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold text-gray-400">總店家數</h2>
                                <p id="shop-count" class="text-4xl font-bold text-green-400">0</p>
                            </div>
                             <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold text-gray-400">總回報數</h2>
                                <p id="feedback-count" class="text-4xl font-bold text-green-400">0</p>
                            </div>
                        </div>
                    </div>
                    <!-- Subscribers Content -->
                    <div id="subscribers-content" class="tab-pane hidden">
                        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-white">訂閱者管理</h1>
                        <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg overflow-x-auto">
                            <table class="w-full text-left min-w-[600px]">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3">電子郵件</th>
                                        <th class="p-3">訂閱時間</th>
                                        <th class="p-3">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="subscribers-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Shops Content -->
                    <div id="shops-content" class="tab-pane hidden">
                         <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                            <h1 class="text-2xl md:text-3xl font-bold text-white">店家管理</h1>
                            <button id="add-shop-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-plus mr-2"></i> 新增店家
                            </button>
                        </div>
                        <div class="mb-4 flex flex-col md:flex-row gap-4">
                            <div class="relative flex-grow">
                                <input type="text" id="shop-search-input" placeholder="搜尋ID、名稱、地址..." class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <select id="shop-type-filter" class="bg-gray-700 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="all">所有類型</option>
                            </select>
                        </div>
                         <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg overflow-x-auto">
                            <table class="w-full text-left min-w-[700px]">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3">ID</th>
                                        <th class="p-3">中文名稱</th>
                                        <th class="p-3">類型</th>
                                        <th class="p-3">地址</th>
                                        <th class="p-3">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="shops-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Feedback Content -->
                    <div id="feedback-content" class="tab-pane hidden">
                        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-white">回報管理</h1>
                        <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[800px]">
                                    <thead class="border-b border-gray-700">
                                        <tr>
                                            <th class="p-3">時間</th>
                                            <th class="p-3">店家</th>
                                            <th class="p-3">類型</th>
                                            <th class="p-3">內容</th>
                                            <th class="p-3">狀態</th>
                                            <th class="p-3">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedback-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Content (Announcements/Policies) Content -->
                    <div id="content-content" class="tab-pane hidden">
                        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-white">公告與政策管理</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-xl font-bold mb-4">網站公告</h2>
                                <textarea id="announcements-text" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                <button id="save-announcements-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">儲存公告</button>
                            </div>
                            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-xl font-bold mb-4">政策內容</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="font-bold">隱私權政策</label>
                                        <textarea id="policy-privacy" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                        <button onclick="savePolicy('privacy')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">儲存</button>
                                    </div>
                                    <div>
                                        <label class="font-bold">免責聲明</label>
                                        <textarea id="policy-disclaimer" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                        <button onclick="savePolicy('disclaimer')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">儲存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Shop Edit Modal -->
    <div id="shop-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 id="shop-modal-title" class="text-2xl font-bold mb-6 text-green-400"></h2>
            <form id="shop-form">
                <input type="hidden" id="shop-id">
                <div id="shop-form-fields" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"></div>
            </form>
             <div class="flex justify-end space-x-4 mt-8">
                <button type="button" id="cancel-shop-edit" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">取消</button>
                <button type="button" id="save-shop-btn" class="px-6 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition">儲存</button>
            </div>
        </div>
    </div>
    
    <script>
        // =================================================================
        // CONFIGURATION & STATE
        // =================================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIcS0WXSQV0yNt5lyjvHy7hwDIUItkGeG78T_Yz2mKa83HJMgI9UxsfVIelU6PyKFwkw/exec';
        let allAdminShops = [];
        const loginScreen = document.getElementById('login-screen'), dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form'), logoutButton = document.getElementById('logout-button');
        const tabLinks = document.querySelectorAll('.tab-link'), tabPanes = document.querySelectorAll('.tab-pane');
        const mobileMenuButton = document.getElementById('mobile-menu-button'), closeSidebarButton = document.getElementById('close-sidebar-button'), sidebar = document.getElementById('sidebar');
        const shopSearchInput = document.getElementById('shop-search-input'), shopTypeFilter = document.getElementById('shop-type-filter');

        // =================================================================
        // API CALLER
        // =================================================================
        const apiCall = async (action, payload = {}) => {
            const token = localStorage.getItem('jwtToken');
            if (!token && action !== 'login') { showLoginScreen(); throw new Error('No token found'); }
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', redirect: "follow", body: JSON.stringify({ action, token, ...payload }), headers: { "Content-Type": "text/plain;charset=utf-8" } });
                const result = await response.json();
                if (result.status === 'error') { if (result.message.includes('token')) { showLoginScreen(); } throw new Error(result.message); }
                return result.data;
            } catch (error) { console.error(`API call failed for action "${action}":`, error); alert(`操作失敗: ${error.message}`); throw error; }
        };
        
        // =================================================================
        // INITIALIZATION & EVENT LISTENERS
        // =================================================================
        if (localStorage.getItem('jwtToken')) { showDashboardScreen(); }
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const p = document.getElementById('password').value, err = document.getElementById('login-error'); err.textContent = ''; try { const d = await apiCall('login', { password: p }); localStorage.setItem('jwtToken', d.token); showDashboardScreen(); } catch (error) { err.textContent = `登入失敗：${error.message}`; } });
        logoutButton.addEventListener('click', () => { localStorage.removeItem('jwtToken'); showLoginScreen(); });
        mobileMenuButton.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
        closeSidebarButton.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));
        tabLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); switchTab(link.dataset.tab); if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full'); }); });
        shopSearchInput.addEventListener('input', filterAndRenderShops);
        shopTypeFilter.addEventListener('change', filterAndRenderShops);

        // =================================================================
        // UI & NAVIGATION
        // =================================================================
        function showLoginScreen() { loginScreen.classList.remove('hidden'); dashboardScreen.classList.add('hidden'); }
        function showDashboardScreen() { loginScreen.classList.add('hidden'); dashboardScreen.classList.remove('hidden'); loadDashboardStats(); switchTab('dashboard'); }
        function switchTab(tabName) {
            tabLinks.forEach(l => { l.classList.toggle('tab-active', l.dataset.tab === tabName); l.classList.toggle('bg-gray-700', l.dataset.tab === tabName); });
            tabPanes.forEach(p => { p.classList.toggle('hidden', p.id !== `${tabName}-content`); });
            const actions = { dashboard: loadDashboardStats, subscribers: loadSubscribers, shops: loadShops, content: loadContent, feedback: loadFeedback };
            if (actions[tabName]) actions[tabName]();
        }
        
        // =================================================================
        // DATA LOADING & RENDERING FUNCTIONS
        // =================================================================
        async function loadDashboardStats() { try { const s = await apiCall('getDashboardStats'); document.getElementById('subscriber-count').textContent = s.subscriberCount; document.getElementById('shop-count').textContent = s.shopCount; document.getElementById('feedback-count').textContent = s.feedbackCount; } catch (e) {} }
        async function loadSubscribers() { const t = document.getElementById('subscribers-table'); t.innerHTML = '<tr><td colspan="3" class="p-3 text-center">載入中...</td></tr>'; try { const subs = await apiCall('getSubscribers'); t.innerHTML = subs.map(s => ` <tr class="border-b border-gray-700 hover:bg-gray-700"> <td class="p-3">${s.email}</td> <td class="p-3">${new Date(s.timestamp).toLocaleString()}</td> <td class="p-3"> <button onclick="deleteSubscriber('${s.email}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button> </td> </tr> `).join(''); } catch (e) { t.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-red-400">無法載入訂閱者資料</td></tr>'; } }
        async function deleteSubscriber(email) { if (confirm(`確定要刪除訂閱者 ${email} 嗎？`)) { try { await apiCall('deleteSubscriber', { email }); alert('刪除成功'); loadSubscribers(); } catch (e) {} } }
        async function loadShops() { const t = document.getElementById('shops-table'); t.innerHTML = '<tr><td colspan="5" class="p-3 text-center">載入中...</td></tr>'; try { allAdminShops = await apiCall('getShops'); populateShopFilter(); renderShopsTable(allAdminShops); } catch (e) { t.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-red-400">無法載入店家資料</td></tr>'; } }
        function populateShopFilter() { const types = [...new Set(allAdminShops.map(s => s['type_zh-TW']).filter(Boolean))].sort(); shopTypeFilter.innerHTML = '<option value="all">所有類型</option>'; types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; shopTypeFilter.appendChild(o); }); }
        function renderShopsTable(shops) { const t = document.getElementById('shops-table'); if (shops.length === 0) { t.innerHTML = '<tr><td colspan="5" class="p-3 text-center">找不到符合條件的店家</td></tr>'; return; } t.innerHTML = shops.map(s => ` <tr class="border-b border-gray-700 hover:bg-gray-700"> <td class="p-3 font-mono text-sm">${s.id}</td> <td class="p-3 font-bold">${s['name_zh-TW']}</td> <td class="p-3">${s['type_zh-TW']}</td> <td class="p-3">${s['address_zh-TW']}</td> <td class="p-3 space-x-2"> <button onclick="editShop('${s.id}')" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button> <button onclick="deleteShop('${s.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button> </td> </tr> `).join(''); }
        function filterAndRenderShops() { const st = shopSearchInput.value.toLowerCase(), stype = shopTypeFilter.value; renderShopsTable(allAdminShops.filter(s => ((s.id?.toLowerCase() || '').includes(st) || (s['name_zh-TW']?.toLowerCase() || '').includes(st) || (s['address_zh-TW']?.toLowerCase() || '').includes(st)) && (stype === 'all' || s['type_zh-TW'] === stype))); }
        async function deleteShop(id) { if (confirm(`確定要刪除店家 ID: ${id} 嗎？`)) { try { await apiCall('deleteShop', { id }); alert('刪除成功'); loadShops(); } catch(e) {} } }
        async function loadContent() { try { const [a, p] = await Promise.all([apiCall('getAnnouncements'), apiCall('getPolicies')]); document.getElementById('announcements-text').value = a; p.forEach(pol => { const k = pol.key.trim(); if(document.getElementById(`policy-${k}`)) document.getElementById(`policy-${k}`).value = pol.value; }); } catch (e) {} }
        document.getElementById('save-announcements-btn').addEventListener('click', async () => { const a = document.getElementById('announcements-text').value; try { await apiCall('setAnnouncements', { announcements: a }); alert('公告儲存成功'); } catch (e) {} });
        async function savePolicy(key) { const c = document.getElementById(`policy-${key}`).value; try { await apiCall('setPolicy', { key, value: c }); alert(`${key === 'privacy' ? '隱私權政策' : '免責聲明'} 儲存成功`); } catch (e) {} }
        async function loadFeedback() { const t = document.getElementById('feedback-table'); t.innerHTML = '<tr><td colspan="6" class="p-3 text-center">載入中...</td></tr>'; try { const f = await apiCall('getFeedback'); renderFeedbackTable(f); } catch (e) { t.innerHTML = '<tr><td colspan="6" class="p-3 text-center text-red-400">無法載入回報資料</td></tr>'; } }
        function renderFeedbackTable(feedbacks) { const t = document.getElementById('feedback-table'), sm = { new: '新的', read: '已讀', resolved: '已解決' }, sc = { new: 'status-new', read: 'status-read', resolved: 'status-resolved' }; if (feedbacks.length === 0) { t.innerHTML = '<tr><td colspan="6" class="p-3 text-center">沒有回報紀錄</td></tr>'; return; } t.innerHTML = feedbacks.map(f => ` <tr class="border-b border-gray-700 hover:bg-gray-700"> <td class="p-3">${new Date(f.Timestamp).toLocaleString()}</td> <td class="p-3">${f['Shop Name'] || 'N/A'}</td> <td class="p-3">${f['Feedback Type']}</td> <td class="p-3 truncate max-w-xs" title="${f.Comment}">${f.Comment}</td> <td class="p-3"><span class="status-badge ${sc[f.Status] || 'bg-gray-500'}">${sm[f.Status] || f.Status}</span></td> <td class="p-3"> <select class="status-select bg-gray-600 rounded p-1" data-timestamp="${f.Timestamp}"> <option value="new" ${f.Status === 'new' ? 'selected' : ''}>新的</option> <option value="read" ${f.Status === 'read' ? 'selected' : ''}>已讀</option> <option value="resolved" ${f.Status === 'resolved' ? 'selected' : ''}>已解決</option> </select> <button class="update-status-btn ml-2 bg-blue-600 hover:bg-blue-700 text-white text-sm py-1 px-2 rounded" data-timestamp="${f.Timestamp}">更新</button> </td> </tr> `).join(''); document.querySelectorAll('.update-status-btn').forEach(b => { b.addEventListener('click', async (e) => { const ts = e.target.dataset.timestamp, ns = document.querySelector(`select[data-timestamp="${ts}"]`).value; try { await apiCall('updateFeedbackStatus', { timestamp: ts, newStatus: ns }); alert('狀態更新成功'); loadFeedback(); } catch (err) {} }); }); }

        // =================================================================
        // SHOP MODAL LOGIC (IMAGE FEATURE REMOVED)
        // =================================================================
        const shopModal = document.getElementById('shop-modal'), shopFormFields = document.getElementById('shop-form-fields'), shopModalTitle = document.getElementById('shop-modal-title'), shopIdField = document.getElementById('shop-id');
        const shopFieldDefinitions = [ { key: 'name_zh-TW', label: '中文名稱', type: 'text', required: true }, { key: 'name_en', label: '英文名稱', type: 'text', required: true }, { key: 'type_zh-TW', label: '中文類型', type: 'text' }, { key: 'type_en', label: '英文類型', type: 'text' }, { key: 'address_zh-TW', label: '中文地址', type: 'text' }, { key: 'address_en', label: '英文地址', type: 'text' }, { key: 'hours_zh-TW', label: '中文營業時間', type: 'text' }, { key: 'hours_en', label: '英文營業時間', type: 'text' }, { key: 'phone', label: '電話', type: 'text' }, { key: 'email', label: '電子郵件', type: 'email' }, { key: 'website', label: '網站', type: 'text' }, { key: 'lat', label: '緯度 (Lat)', type: 'number', required: true }, { key: 'lng', label: '經度 (Lng)', type: 'number', required: true }, { key: 'description_zh-TW', label: '中文簡短描述', type: 'textarea' }, { key: 'description_en', label: '英文簡短描述', type: 'textarea' }, { key: 'longDescription_zh-TW', label: '中文詳細描述', type: 'textarea' }, { key: 'longDescription_en', label: '英文詳細描述', type: 'textarea' }, { key: 'sustainability_zh-TW', label: '中文永續特色', type: 'textarea' }, { key: 'sustainability_en', label: '英文永續特色', type: 'textarea' }, { key: 'tags_zh-TW', label: '中文標籤 (逗號分隔)', type: 'text' }, { key: 'tags_en', label: '英文標籤 (逗號分隔)', type: 'text' }, ];
        
        shopFormFields.innerHTML = shopFieldDefinitions.map(f => {
            const inputId = `shop-${f.key.replace(/_/g, '-')}`;
            const labelHtml = `<label for="${inputId}" class="block text-gray-400 mb-2">${f.label}${f.required ? ' *' : ''}</label>`;
            let inputHtml = '';
            if (f.type === 'textarea') {
                inputHtml = `<textarea id="${inputId}" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>`;
            } else {
                inputHtml = `<input type="${f.type}" step="any" id="${inputId}" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" ${f.required ? 'required' : ''}>`;
            }
            const colSpan = (f.type === 'textarea') ? 'md:col-span-2' : '';
            return `<div class="${colSpan}">${labelHtml}${inputHtml}</div>`;
        }).join('');

        document.getElementById('add-shop-btn').addEventListener('click', () => { shopModalTitle.textContent = '新增店家'; shopIdField.value = ''; shopFieldDefinitions.forEach(f => { document.getElementById(`shop-${f.key.replace(/_/g, '-')}`).value = ''; }); shopModal.classList.remove('hidden'); });
        async function editShop(id) { shopModalTitle.textContent = '編輯店家'; shopIdField.value = id; try { const s = await apiCall('getShopById', { id }); shopFieldDefinitions.forEach(f => { document.getElementById(`shop-${f.key.replace(/_/g, '-')}`).value = s[f.key] || ''; }); shopModal.classList.remove('hidden'); } catch(e) {} }
        document.getElementById('cancel-shop-edit').addEventListener('click', () => { shopModal.classList.add('hidden'); });
        document.getElementById('save-shop-btn').addEventListener('click', async () => { const d = { id: shopIdField.value }; let v = true; shopFieldDefinitions.forEach(f => { const i = document.getElementById(`shop-${f.key.replace(/_/g, '-')}`); if (f.required && !i.value) v = false; d[f.key] = i.value; }); if(!v) { alert('請填寫所有必填欄位 (*)'); return; } try { await apiCall('saveShop', { shop: d }); alert('店家資料儲存成功'); shopModal.classList.add('hidden'); loadShops(); } catch(e) {} });
        
        window.savePolicy = savePolicy; window.editShop = editShop; window.deleteShop = deleteShop; window.deleteSubscriber = deleteSubscriber;
    </script>
</body>
</html>

