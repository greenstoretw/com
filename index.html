<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>永續商店地圖 · 後台（舊UI＋推薦信/法律聲明）</title>
<style>
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;background:#f6f7f9;color:#111}
  .layout{display:flex;min-height:100vh}
  .aside{width:220px;background:#fff;border-right:1px solid #e5e7eb;padding:16px 12px}
  .brand{font-weight:700;color:#166534;margin:4px 6px 16px}
  .nav button{display:block;width:100%;text-align:left;padding:10px 12px;margin:6px 0;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer}
  .nav button.active{background:#166534;color:#fff;border-color:#166534}
  .main{flex:1;padding:18px 20px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin-bottom:16px}
  .row{display:grid;gap:10px}
  .row-2{grid-template-columns:1fr 1fr}
  input,textarea,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font:inherit}
  textarea{min-height:120px;resize:vertical}
  .btn{border:0;border-radius:8px;padding:10px 14px;cursor:pointer;font:inherit}
  .btn-primary{background:#166534;color:#fff}
  .btn-ghost{background:#f3f4f6;border:1px solid #e5e7eb}
  .muted{color:#6b7280;font-size:13px}
  .hidden{display:none}
  .list-row{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:6px 0}
  .right{text-align:right}
  @media(max-width:720px){.row-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="layout">
  <aside class="aside">
    <div class="brand">永續商店地圖 · 後台</div>
    <div class="nav">
      <button data-pane="dash" class="active">儀表板</button>
      <button data-pane="shops">商店管理</button>
      <button data-pane="subs">訂閱者管理</button>
      <button data-pane="ann">公告管理</button>
      <button data-pane="pol">法律聲明管理</button>
      <button data-pane="send">推薦信管理</button>
    </div>
    <div class="card">
      <div class="muted">狀態：<span id="status">未登入</span></div>
      <div id="loginBox" style="margin-top:8px">
        <input id="pwd" type="password" placeholder="管理員密碼（ADMIN_PASSWORD）" />
        <button id="loginBtn" class="btn btn-primary" style="margin-top:8px">登入</button>
        <div id="loginMsg" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </aside>

  <main class="main">
    <!-- 儀表板 -->
    <section id="pane-dash" class="card">
      <h3>儀表板</h3>
      <div class="row row-2">
        <div class="card"><b>商店總數：</b> <span id="mShop">—</span></div>
        <div class="card"><b>訂閱者總數：</b> <span id="mSub">—</span></div>
      </div>
      <div class="muted" style="margin-top:8px">近30天每日新增：<span id="mTrend"></span></div>
    </section>

    <!-- 商店管理 -->
    <section id="pane-shops" class="card hidden">
      <h3>商店管理</h3>
      <div class="row row-2">
        <input id="s_id" placeholder="id（必填，唯一）" />
        <input id="s_name" placeholder="name_zh-TW" />
      </div>
      <div class="row row-2">
        <input id="s_addr" placeholder="address_zh-TW" />
        <input id="s_desc" placeholder="description_zh-TW" />
      </div>
      <div class="right" style="margin-top:8px">
        <button id="shopSave" class="btn btn-primary">新增/更新</button>
        <button id="shopDelete" class="btn btn-ghost">刪除此 id</button>
        <button id="shopReload" class="btn btn-ghost">重新整理</button>
      </div>
      <div id="shopList" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- 訂閱者管理 -->
    <section id="pane-subs" class="card hidden">
      <h3>訂閱者管理</h3>
      <button id="loadSubs" class="btn btn-ghost">重新整理</button>
      <div id="subsList" style="margin-top:8px"></div>

      <div class="card" style="margin-top:12px">
        <div class="muted">一鍵群發推薦信（寄給所有訂閱者）</div>
        <div class="row" style="margin-top:8px">
          <select id="shopSelect"></select>
          <div class="right"><button id="broadcast" class="btn btn-primary">送出</button></div>
        </div>
      </div>
    </section>

    <!-- 公告管理 -->
    <section id="pane-ann" class="card hidden">
      <h3>公告管理</h3>
      <textarea id="annHtml" placeholder="<p>公告內容...</p>"></textarea>
      <div class="right" style="margin-top:8px">
        <button id="saveAnn" class="btn btn-primary">儲存公告</button>
      </div>
      <div id="annMsg" class="muted" style="margin-top:6px"></div>
    </section>

    <!-- 法律聲明管理 -->
    <section id="pane-pol" class="card hidden">
      <h3>法律聲明管理</h3>
      <label class="muted">隱私權政策</label>
      <textarea id="polPrivacy"></textarea>
      <label class="muted" style="margin-top:8px">免責聲明</label>
      <textarea id="polDisclaimer"></textarea>
      <div class="right" style="margin-top:8px">
        <button id="savePol" class="btn btn-primary">儲存法律聲明</button>
      </div>
      <div id="polMsg" class="muted" style="margin-top:6px"></div>
    </section>

    <!-- 推薦信管理（單筆） -->
    <section id="pane-send" class="card hidden">
      <h3>推薦信管理</h3>
      <div class="row row-2">
        <input id="recEmail" type="email" placeholder="收件者 Email" />
        <select id="shopSelect2"></select>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="sendOne" class="btn btn-primary">寄出推薦信（單筆）</button>
      </div>
      <div id="sendMsg" class="muted" style="margin-top:6px"></div>
    </section>
  </main>
</div>

<script>
  // === 你的 GAS Web App URL（已套用你提供的網址） ===
  const API = 'https://script.google.com/macros/s/AKfycbx4NR0LWj6j27lB_1-LxIDthj2ihaGyEQTQ1hqUNMyX5KC7a1bQtzpZwJYQVvq-6aILUA/exec';

  let TOKEN = '';
  const $ = id => document.getElementById(id);
  const call = async (action, body) =>
    fetch(API, { method:'POST', body: JSON.stringify(Object.assign({ action, token:TOKEN }, body||{})) })
      .then(r => r.json());
  const toast = (el, ok, msg) => { el.textContent = (ok?'✔ ':'✖ ') + msg; setTimeout(()=>el.textContent='', 2500); };

  // 切換面板（舊UI左側側欄）
  document.querySelectorAll('.nav button').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.pane;
      document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
      $('pane-'+t).classList.remove('hidden');
    };
  });

  // 登入
  $('loginBtn').onclick = async ()=>{
    $('loginMsg').textContent = '登入中…';
    try{
      const res = await fetch(API, { method:'POST', body: JSON.stringify({ action:'adminLogin', password:$('pwd').value }) }).then(r=>r.json());
      if(res.success){
        TOKEN = res.token;
        $('status').textContent = '已登入';
        $('loginBox').style.display = 'none';
        loadAll();
      }else{
        $('loginMsg').textContent = '登入失敗：' + (res.error||'');
      }
    }catch(e){
      $('loginMsg').textContent = '登入錯誤：' + e.message;
    }
  };

  // 初始資料載入
  async function loadAll(){
    try{ const s = await call('getStats'); $('mShop').textContent=s.shopCount; $('mSub').textContent=s.subCount; $('mTrend').textContent=(s.trend||[]).map(x=>x.add).join(','); }catch(_){}
    try{ const a = await call('getAnnouncement'); $('annHtml').value = a.html||''; }catch(_){}
    try{ const p = await call('getPolicies'); $('polPrivacy').value = p.privacy||''; $('polDisclaimer').value = p.disclaimer||''; }catch(_){}
    loadSubs();
    loadShops();
  }

  // 公告 / 法律聲明
  $('saveAnn').onclick = async ()=>{
    const r = await call('setAnnouncement', { html: $('annHtml').value });
    toast($('annMsg'), r.success, r.success?'已儲存':'失敗：'+(r.error||''));
  };
  $('savePol').onclick = async ()=>{
    const r = await call('setPolicies', { privacy:$('polPrivacy').value, disclaimer:$('polDisclaimer').value });
    toast($('polMsg'), r.success, r.success?'已儲存':'失敗：'+(r.error||''));
  };

  // 訂閱者
  async function loadSubs(){
    const r = await call('getSubscribers'); const arr = r.subscribers || [];
    const box = $('subsList');
    box.innerHTML = arr.length
      ? arr.map(s=>`<div class="list-row"><span>${s.email}</span><button class="btn btn-ghost" data-mail="${s.email}">刪除</button></div>`).join('')
      : '尚無訂閱者';
    box.querySelectorAll('button').forEach(b=>{
      b.onclick = async ()=>{
        await call('deleteSubscriber', { email: b.dataset.mail });
        b.parentElement.remove();
      };
    });
  }
  $('loadSubs').onclick = loadSubs;

  // 商店
  async function loadShops(){
    const r = await call('getShops'); const arr = r.shops || [];
    $('shopList').innerHTML = arr.length
      ? arr.map(x=>`<div class="list-row"><span>${x.id}｜${x['name_zh-TW']||x.name_en||''}</span></div>`).join('')
      : '目前沒有資料';

    const opts = `<option value="">（不指定商店）</option>` +
      arr.map(x=>`<option value="${x.id}">${x['name_zh-TW']||x.name_en||x.id}</option>`).join('');
    $('shopSelect').innerHTML  = opts;
    $('shopSelect2').innerHTML = opts;
  }
  $('shopSave').onclick = async ()=>{
    const shop = {
      id: $('s_id').value.trim(),
      'name_zh-TW': $('s_name').value.trim(),
      'address_zh-TW': $('s_addr').value.trim(),
      'description_zh-TW': $('s_desc').value.trim()
    };
    if(!shop.id) return alert('請先填 id');
    const r = await call('upsertShop', { shop });
    if(r.success){ loadShops(); alert('已儲存'); } else alert('失敗：'+(r.error||''));
  };
  $('shopDelete').onclick = async ()=>{
    const id = $('s_id').value.trim();
    if(!id) return alert('請先填 id');
    const r = await call('deleteShop', { id });
    if(r.success){ loadShops(); alert('已刪除'); } else alert('失敗：'+(r.error||''));
  };
  $('shopReload').onclick = loadShops;

  // 推薦信（群發 / 單筆）
  $('broadcast').onclick = async ()=>{
    const r = await call('broadcastRecommendWithShop', { storeId: $('shopSelect').value || '' });
    alert(r.success ? `已送出：${r.sent}/${r.total}（失敗 ${r.failed}）` : ('失敗：' + (r.error||'')));
  };
  $('sendOne').onclick = async ()=>{
    const r = await call('recommendWithShop', { email: $('recEmail').value.trim(), storeId: $('shopSelect2').value || '' });
    toast($('sendMsg'), r.success, r.success?'已發送':'失敗：'+(r.error||''));
  };
</script>
</body>
</html>
